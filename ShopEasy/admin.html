<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ShopEasy</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">ShopEasy</a>
            <div class="nav-links">
                <a href="index.html"><i class="fas fa-home"></i> Home</a>
                <a href="shop.html"><i class="fas fa-shopping-bag"></i> Shop</a>
                <a href="cart.html"><i class="fas fa-shopping-cart"></i> Cart <span id="cart-count" class="cart-count">0</span></a>
                <div class="auth-links">
                    <a href="login.html" id="login-btn"><i class="fas fa-user"></i> Login</a>
                    <a href="#" id="logout-btn" style="display: none;"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    <a href="admin.html" class="active" id="admin-btn" style="display: none;"><i class="fas fa-cog"></i> Admin</a>
                </div>
            </div>
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Admin Dashboard -->
    <section class="admin-dashboard">
        <div class="container">
            <div class="admin-header">
                <h1>Admin Dashboard</h1>
                <p>Manage your e-commerce platform</p>
            </div>
            
            <!-- Admin Tabs -->
            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
                <button class="tab-btn" data-tab="products">Products</button>
                <button class="tab-btn" data-tab="orders">Orders</button>
                <button class="tab-btn" data-tab="users">Users</button>
                <button class="tab-btn" data-tab="add-product">Add Product</button>
            </div>
            
            <!-- Tab Contents -->
            <div class="tab-contents">
                <!-- Dashboard Tab -->
                <div class="tab-content active" id="dashboard-tab">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-products">0</h3>
                                <p>Total Products</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-orders">0</h3>
                                <p>Total Orders</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-users">0</h3>
                                <p>Total Users</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-revenue">$0</h3>
                                <p>Total Revenue</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recent-orders">
                        <h3>Recent Orders</h3>
                        <div class="table-container">
                            <table id="recent-orders-table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Orders will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Products Tab -->
                <div class="tab-content" id="products-tab">
                    <div class="section-header">
                        <h3>All Products</h3>
                        <button class="btn btn-primary" id="refresh-products">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Orders Tab -->
                <div class="tab-content" id="orders-tab">
                    <div class="section-header">
                        <h3>All Orders</h3>
                        <div class="filter-orders">
                            <select id="order-status-filter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="orders-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Users Tab -->
                <div class="tab-content" id="users-tab">
                    <div class="section-header">
                        <h3>Registered Users</h3>
                    </div>
                    <div class="table-container">
                        <table id="users-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Add Product Tab -->
                <div class="tab-content" id="add-product-tab">
                    <div class="section-header">
                        <h3>Add New Product</h3>
                    </div>
                    <form id="add-product-form" class="admin-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-name">Product Name *</label>
                                <input type="text" id="product-name" required>
                            </div>
                            <div class="form-group">
                                <label for="product-category">Category *</label>
                                <select id="product-category" required>
                                    <option value="">Select Category</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Fashion">Fashion</option>
                                    <option value="Home">Home</option>
                                    <option value="Sports">Sports</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-description">Description</label>
                            <textarea id="product-description" rows="3"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-price">Price ($) *</label>
                                <input type="number" id="product-price" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="product-stock">Stock *</label>
                                <input type="number" id="product-stock" min="0" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-image">Image URL</label>
                            <input type="url" id="product-image" placeholder="https://example.com/image.jpg">
                            <small>Leave empty for default image</small>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Add Product</button>
                            <button type="reset" class="btn btn-secondary">Clear Form</button>
                        </div>
                        
                        <div id="product-form-message" class="form-message" style="display: none;"></div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Edit Product Modal -->
    <div class="modal" id="edit-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Product</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="edit-product-form" class="admin-form">
                <input type="hidden" id="edit-product-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-product-name">Product Name *</label>
                        <input type="text" id="edit-product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-category">Category *</label>
                        <select id="edit-product-category" required>
                            <option value="">Select Category</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Home">Home</option>
                            <option value="Sports">Sports</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-product-description">Description</label>
                    <textarea id="edit-product-description" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-product-price">Price ($) *</label>
                        <input type="number" id="edit-product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-stock">Stock *</label>
                        <input type="number" id="edit-product-stock" min="0" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-product-image">Image URL</label>
                    <input type="url" id="edit-product-image" placeholder="https://example.com/image.jpg">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Update Product</button>
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                </div>
                
                <div id="edit-product-message" class="form-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="order-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Order Details</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="order-details-content">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ShopEasy</h3>
                    <p>Your trusted online shopping destination</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <a href="index.html">Home</a>
                    <a href="shop.html">Shop</a>
                    <a href="cart.html">Cart</a>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p>Email: mrymhassan@shopeasy.com</p>
                    <p>Phone: (+92) 321-8121137</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 ShopEasy. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Supabase Configuration - REPLACE WITH YOUR OWN CREDENTIALS
        const SUPABASE_URL = 'https://busxhfkirarsovdzepza.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_n04xz2UVJutlInF3dBgQtg__33bRNLt';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Check authentication state and admin role
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                // Not logged in, redirect to login
                window.location.href = 'login.html';
                return;
            }
            
            // Check if user is admin
            const userRole = session.user.user_metadata?.role;
            if (userRole !== 'admin') {
                // Not an admin, redirect to home
                alert('Access denied. Admin privileges required.');
                window.location.href = 'index.html';
                return;
            }
            
            updateAuthUI(session);
            
            supabase.auth.onAuthStateChange((event, session) => {
                if (!session || session.user.user_metadata?.role !== 'admin') {
                    window.location.href = 'login.html';
                } else {
                    updateAuthUI(session);
                }
            });
        }
        
        function updateAuthUI(session) {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const adminBtn = document.getElementById('admin-btn');
            
            if (session) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                adminBtn.style.display = 'inline-block';
            } else {
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                adminBtn.style.display = 'none';
            }
        }
        
        // Logout function
        document.getElementById('logout-btn')?.addEventListener('click', async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });
        
        // Cart functionality
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
        }
        
        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
                
                // Show corresponding tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Load data for the tab if needed
                if (tabId === 'dashboard') {
                    loadDashboardStats();
                } else if (tabId === 'products') {
                    loadProductsTable();
                } else if (tabId === 'orders') {
                    loadOrdersTable();
                } else if (tabId === 'users') {
                    loadUsersTable();
                }
            });
        });
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                // Get total products
                const { count: productsCount } = await supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true });
                
                // Get total orders
                const { count: ordersCount } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true });
                
                // Get total revenue
                const { data: orders } = await supabase
                    .from('orders')
                    .select('total_amount');
                
                const totalRevenue = orders?.reduce((sum, order) => sum + order.total_amount, 0) || 0;
                
                // Get total users (from auth)
                const { data: { users }, error: usersError } = await supabase.auth.admin.listUsers();
                const totalUsers = users?.length || 0;
                
                // Get recent orders
                const { data: recentOrders } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                // Update UI
                document.getElementById('total-products').textContent = productsCount || 0;
                document.getElementById('total-orders').textContent = ordersCount || 0;
                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
                
                // Update recent orders table
                const recentOrdersTable = document.querySelector('#recent-orders-table tbody');
                if (recentOrders && recentOrders.length > 0) {
                    recentOrdersTable.innerHTML = recentOrders.map(order => `
                        <tr>
                            <td>#${order.id}</td>
                            <td>User ${order.user_id?.substring(0, 8)}...</td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                            <td>$${order.total_amount.toFixed(2)}</td>
                            <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                        </tr>
                    `).join('');
                } else {
                    recentOrdersTable.innerHTML = '<tr><td colspan="5">No recent orders</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        // Load products table
        async function loadProductsTable() {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const productsTable = document.querySelector('#products-table tbody');
                
                if (products && products.length > 0) {
                    productsTable.innerHTML = products.map(product => `
                        <tr>
                            <td>${product.id}</td>
                            <td>
                                <img src="${product.image_url || 'https://via.placeholder.com/50x50'}" 
                                     alt="${product.name}" 
                                     class="product-thumbnail">
                            </td>
                            <td>${product.name}</td>
                            <td>${product.category || 'Uncategorized'}</td>
                            <td>$${product.price.toFixed(2)}</td>
                            <td>${product.stock || 0}</td>
                            <td class="actions-cell">
                                <button class="btn-icon edit-product" data-id="${product.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon delete-product" data-id="${product.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Add event listeners for edit buttons
                    document.querySelectorAll('.edit-product').forEach(button => {
                        button.addEventListener('click', () => editProduct(button.dataset.id));
                    });
                    
                    // Add event listeners for delete buttons
                    document.querySelectorAll('.delete-product').forEach(button => {
                        button.addEventListener('click', () => deleteProduct(button.dataset.id));
                    });
                    
                } else {
                    productsTable.innerHTML = '<tr><td colspan="7">No products found</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Error loading products. Please try again.');
            }
        }
        
        // Load orders table
        async function loadOrdersTable() {
            try {
                const statusFilter = document.getElementById('order-status-filter').value;
                
                let query = supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                }
                
                const { data: orders, error } = await query;
                
                if (error) throw error;
                
                const ordersTable = document.querySelector('#orders-table tbody');
                
                if (orders && orders.length > 0) {
                    ordersTable.innerHTML = orders.map(order => `
                        <tr>
                            <td>#${order.id}</td>
                            <td>${order.user_id ? `User ${order.user_id.substring(0, 8)}...` : 'Guest'}</td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn-text view-order-items" data-id="${order.id}">
                                    View Items
                                </button>
                            </td>
                            <td>$${order.total_amount.toFixed(2)}</td>
                            <td>
                                <span class="status-badge status-${order.status}">${order.status}</span>
                            </td>
                            <td class="actions-cell">
                                <button class="btn-icon update-status" data-id="${order.id}">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn-text view-order-details" data-id="${order.id}">
                                    Details
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Add event listeners
                    document.querySelectorAll('.view-order-items').forEach(button => {
                        button.addEventListener('click', () => viewOrderItems(button.dataset.id));
                    });
                    
                    document.querySelectorAll('.view-order-details').forEach(button => {
                        button.addEventListener('click', () => viewOrderDetails(button.dataset.id));
                    });
                    
                    document.querySelectorAll('.update-status').forEach(button => {
                        button.addEventListener('click', () => updateOrderStatus(button.dataset.id));
                    });
                    
                } else {
                    ordersTable.innerHTML = '<tr><td colspan="7">No orders found</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading orders:', error);
                alert('Error loading orders. Please try again.');
            }
        }
        
        // Load users table
        async function loadUsersTable() {
            try {
                const { data: { users }, error } = await supabase.auth.admin.listUsers();
                
                if (error) throw error;
                
                const usersTable = document.querySelector('#users-table tbody');
                
                if (users && users.length > 0) {
                    usersTable.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.id.substring(0, 8)}...</td>
                            <td>${user.user_metadata?.name || 'N/A'}</td>
                            <td>${user.email}</td>
                            <td>
                                <span class="role-badge role-${user.user_metadata?.role || 'customer'}">
                                    ${user.user_metadata?.role || 'customer'}
                                </span>
                            </td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                } else {
                    usersTable.innerHTML = '<tr><td colspan="5">No users found</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading users:', error);
                usersTable.innerHTML = '<tr><td colspan="5">Error loading users</td></tr>';
            }
        }
        
        // View order items
        async function viewOrderItems(orderId) {
            try {
                const { data: orderItems, error } = await supabase
                    .from('order_items')
                    .select(`
                        quantity,
                        price,
                        products (name)
                    `)
                    .eq('order_id', orderId);
                
                if (error) throw error;
                
                if (orderItems && orderItems.length > 0) {
                    const itemsList = orderItems.map(item => 
                        `${item.quantity}x ${item.products.name} - $${(item.quantity * item.price).toFixed(2)}`
                    ).join('\n');
                    
                    alert(`Order #${orderId} Items:\n\n${itemsList}`);
                } else {
                    alert('No items found for this order.');
                }
                
            } catch (error) {
                console.error('Error loading order items:', error);
                alert('Error loading order items.');
            }
        }
        
        // View order details
        async function viewOrderDetails(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();
                
                if (error) throw error;
                
                const modal = document.getElementById('order-details-modal');
                const content = document.getElementById('order-details-content');
                
                content.innerHTML = `
                    <div class="order-details">
                        <div class="detail-row">
                            <strong>Order ID:</strong> ${order.id}
                        </div>
                        <div class="detail-row">
                            <strong>Customer ID:</strong> ${order.user_id || 'Guest'}
                        </div>
                        <div class="detail-row">
                            <strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}
                        </div>
                        <div class="detail-row">
                            <strong>Total Amount:</strong> $${order.total_amount.toFixed(2)}
                        </div>
                        <div class="detail-row">
                            <strong>Status:</strong> <span class="status-badge status-${order.status}">${order.status}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Shipping Address:</strong><br>
                            ${order.shipping_address || 'Not provided'}
                        </div>
                    </div>
                `;
                
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading order details:', error);
                alert('Error loading order details.');
            }
        }
        
        // Update order status
        async function updateOrderStatus(orderId) {
            const newStatus = prompt('Enter new status (pending, processing, shipped, delivered, cancelled):');
            
            if (!newStatus || !['pending', 'processing', 'shipped', 'delivered', 'cancelled'].includes(newStatus)) {
                alert('Invalid status. Please enter a valid status.');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId);
                
                if (error) throw error;
                
                alert('Order status updated successfully!');
                loadOrdersTable();
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Error updating order status.');
            }
        }
        
        // Edit product
        async function editProduct(productId) {
            try {
                const { data: product, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', productId)
                    .single();
                
                if (error) throw error;
                
                // Fill edit form
                document.getElementById('edit-product-id').value = product.id;
                document.getElementById('edit-product-name').value = product.name;
                document.getElementById('edit-product-description').value = product.description || '';
                document.getElementById('edit-product-price').value = product.price;
                document.getElementById('edit-product-stock').value = product.stock || 0;
                document.getElementById('edit-product-image').value = product.image_url || '';
                
                const categorySelect = document.getElementById('edit-product-category');
                categorySelect.value = product.category || '';
                
                // Show modal
                document.getElementById('edit-product-modal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading product for edit:', error);
                alert('Error loading product details.');
            }
        }
        
        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (error) throw error;
                
                alert('Product deleted successfully!');
                loadProductsTable();
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product. You may not have permission.');
            }
        }
        
        // Add new product
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const category = document.getElementById('product-category').value;
            const image_url = document.getElementById('product-image').value;
            
            if (!name || !category || isNaN(price) || isNaN(stock)) {
                alert('Please fill all required fields correctly.');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('products')
                    .insert([{
                        name,
                        description,
                        price,
                        stock,
                        category,
                        image_url: image_url || null
                    }]);
                
                if (error) throw error;
                
                document.getElementById('product-form-message').textContent = 'Product added successfully!';
                document.getElementById('product-form-message').style.color = 'green';
                document.getElementById('product-form-message').style.display = 'block';
                
                // Clear form
                e.target.reset();
                
                // Reload products table and dashboard
                setTimeout(() => {
                    loadProductsTable();
                    loadDashboardStats();
                }, 1000);
                
            } catch (error) {
                console.error('Error adding product:', error);
                document.getElementById('product-form-message').textContent = 'Error adding product: ' + error.message;
                document.getElementById('product-form-message').style.color = '#dc3545';
                document.getElementById('product-form-message').style.display = 'block';
            }
        });
        
        // Update product
        document.getElementById('edit-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('edit-product-id').value;
            const name = document.getElementById('edit-product-name').value;
            const description = document.getElementById('edit-product-description').value;
            const price = parseFloat(document.getElementById('edit-product-price').value);
            const stock = parseInt(document.getElementById('edit-product-stock').value);
            const category = document.getElementById('edit-product-category').value;
            const image_url = document.getElementById('edit-product-image').value;
            
            try {
                const { error } = await supabase
                    .from('products')
                    .update({
                        name,
                        description,
                        price,
                        stock,
                        category,
                        image_url: image_url || null
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                document.getElementById('edit-product-message').textContent = 'Product updated successfully!';
                document.getElementById('edit-product-message').style.color = 'green';
                document.getElementById('edit-product-message').style.display = 'block';
                
                // Reload products table
                setTimeout(() => {
                    loadProductsTable();
                    loadDashboardStats();
                    closeModal('edit-product-modal');
                }, 1000);
                
            } catch (error) {
                console.error('Error updating product:', error);
                document.getElementById('edit-product-message').textContent = 'Error updating product: ' + error.message;
                document.getElementById('edit-product-message').style.color = '#dc3545';
                document.getElementById('edit-product-message').style.display = 'block';
            }
        });
        
        // Modal functionality
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        document.querySelectorAll('.modal-close').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        // Refresh products button
        document.getElementById('refresh-products')?.addEventListener('click', () => {
            loadProductsTable();
        });
        
        // Order status filter
        document.getElementById('order-status-filter')?.addEventListener('change', () => {
            loadOrdersTable();
        });
        
        // Mobile menu toggle
        document.getElementById('menuToggle')?.addEventListener('click', () => {
            document.querySelector('.nav-links').classList.toggle('show');
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            updateCartCount();
            loadDashboardStats();
            
            // Load data for initial tab
            loadProductsTable();
        });
    </script>
</body>
</html>